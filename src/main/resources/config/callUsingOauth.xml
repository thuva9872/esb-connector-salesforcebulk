<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2023, WSO2 LLC. (http://www.wso2.com).
  ~
  ~ WSO2 LLC. licenses this file to you under the Apache License,
  ~ Version 2.0 (the "License"); you may not use this file except
  ~ in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<template name="callUsingOauth" onError="fault" xmlns="http://ws.apache.org/ns/synapse">
	<parameter name="method" description="HTTP Method"/>
	<parameter name="contentType" description="Content Type"/>
	<parameter name="url" description="Endpoint URL"/>
	<sequence>
		<property name="method" expression="$func:method"/>
		<property name="contentType" expression="$func:contentType"/>
		<property name="uri.var.url" expression="$func:url"/>
		<property name="uri.var.clientId" expression="get-property('sf_bulk_clientId')"/>
		<property name="uri.var.clientSecret" expression="get-property('sf_bulk_clientSecret')"/>
		<property name="uri.var.refreshToken" expression="get-property('sf_bulk_refreshToken')"/>
		<property name="uri.var.tokenUrl" expression="get-property('sf_bulk_tokenUrl')"/>
		<property name="REST_URL_POSTFIX" action="remove" scope="axis2"/>
		<filter source="$ctx:uri.var.httpMethod" regex="get">
			<call>
				<endpoint>
					<http method="get"
						  uri-template="{uri.var.url}">
						<timeout>
							<duration>{$ctx:timeout}</duration>
							<responseAction>fault</responseAction>
						</timeout>
						<suspendOnFailure>
							<errorCodes>-1</errorCodes>
							<progressionFactor>1.0</progressionFactor>
						</suspendOnFailure>
						<markForSuspension>
							<errorCodes>-1</errorCodes>
						</markForSuspension>
						<authentication>
							<oauth>
								<authorizationCode>
									<refreshToken>{$ctx:uri.var.refreshToken}</refreshToken>
									<clientId>{$ctx:uri.var.clientId}</clientId>
									<clientSecret>{$ctx:uri.var.clientSecret}</clientSecret>
									<tokenUrl>{$ctx:uri.var.tokenUrl}</tokenUrl>
									<authMode>Header</authMode>
								</authorizationCode>
							</oauth>
						</authentication>
					</http>
				</endpoint>
			</call>
		</filter>
		<!--for HTTP method POST-->
		<filter source="$ctx:uri.var.httpMethod" regex="post">
			<property name="messageType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<property name="ContentType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<call>
				<endpoint>
					<http method="post"
						  uri-template="{uri.var.url}">
						<timeout>
							<duration>{$ctx:timeout}</duration>
							<responseAction>fault</responseAction>
						</timeout>
						<suspendOnFailure>
							<errorCodes>-1</errorCodes>
							<progressionFactor>1.0</progressionFactor>
						</suspendOnFailure>
						<markForSuspension>
							<errorCodes>-1</errorCodes>
						</markForSuspension>
						<authentication>
							<oauth>
								<authorizationCode>
									<refreshToken>{$ctx:uri.var.refreshToken}</refreshToken>
									<clientId>{$ctx:uri.var.clientId}</clientId>
									<clientSecret>{$ctx:uri.var.clientSecret}</clientSecret>
									<tokenUrl>{$ctx:uri.var.tokenUrl}</tokenUrl>
									<authMode>Header</authMode>
								</authorizationCode>
							</oauth>
						</authentication>
					</http>
				</endpoint>
			</call>
		</filter>
		<!--for HTTP method DELETE-->
		<filter source="$ctx:uri.var.httpMethod" regex="delete">
			<property name="messageType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<property name="ContentType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<call>
				<endpoint>
					<http method="delete"
						  uri-template="{uri.var.url}">
						<timeout>
							<duration>{$ctx:timeout}</duration>
							<responseAction>fault</responseAction>
						</timeout>
						<suspendOnFailure>
							<errorCodes>-1</errorCodes>
							<progressionFactor>1.0</progressionFactor>
						</suspendOnFailure>
						<markForSuspension>
							<errorCodes>-1</errorCodes>
						</markForSuspension>
						<authentication>
							<oauth>
								<authorizationCode>
									<refreshToken>{$ctx:uri.var.refreshToken}</refreshToken>
									<clientId>{$ctx:uri.var.clientId}</clientId>
									<clientSecret>{$ctx:uri.var.clientSecret}</clientSecret>
									<tokenUrl>{$ctx:uri.var.tokenUrl}</tokenUrl>
									<authMode>Header</authMode>
								</authorizationCode>
							</oauth>
						</authentication>
					</http>
				</endpoint>
			</call>
		</filter>
		<!--for HTTP method PATCH-->
		<filter source="$ctx:uri.var.httpMethod" regex="patch">
			<property name="messageType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<property name="ContentType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<call>
				<endpoint>
					<http method="patch"
						  uri-template="{uri.var.url}">
						<timeout>
							<duration>{$ctx:timeout}</duration>
							<responseAction>fault</responseAction>
						</timeout>
						<suspendOnFailure>
							<errorCodes>-1</errorCodes>
							<progressionFactor>1.0</progressionFactor>
						</suspendOnFailure>
						<markForSuspension>
							<errorCodes>-1</errorCodes>
						</markForSuspension>
						<authentication>
							<oauth>
								<authorizationCode>
									<refreshToken>{$ctx:uri.var.refreshToken}</refreshToken>
									<clientId>{$ctx:uri.var.clientId}</clientId>
									<clientSecret>{$ctx:uri.var.clientSecret}</clientSecret>
									<tokenUrl>{$ctx:uri.var.tokenUrl}</tokenUrl>
									<authMode>Header</authMode>
								</authorizationCode>
							</oauth>
						</authentication>
					</http>
				</endpoint>
			</call>
		</filter>
		<!--for HTTP method PUT-->
		<filter source="$ctx:uri.var.httpMethod" regex="put">
			<property name="messageType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<property name="ContentType" expression="$ctx:uri.var.contentType" scope="axis2" type="STRING"/>
			<call>
				<endpoint>
					<http method="put"
						  uri-template="{uri.var.url}">
						<timeout>
							<duration>{$ctx:timeout}</duration>
							<responseAction>fault</responseAction>
						</timeout>
						<suspendOnFailure>
							<errorCodes>-1</errorCodes>
							<progressionFactor>1.0</progressionFactor>
						</suspendOnFailure>
						<markForSuspension>
							<errorCodes>-1</errorCodes>
						</markForSuspension>
						<authentication>
							<oauth>
								<authorizationCode>
									<refreshToken>{$ctx:uri.var.refreshToken}</refreshToken>
									<clientId>{$ctx:uri.var.clientId}</clientId>
									<clientSecret>{$ctx:uri.var.clientSecret}</clientSecret>
									<tokenUrl>{$ctx:uri.var.tokenUrl}</tokenUrl>
									<authMode>Header</authMode>
								</authorizationCode>
							</oauth>
						</authentication>
					</http>
				</endpoint>
			</call>
		</filter>
	</sequence>
</template>
